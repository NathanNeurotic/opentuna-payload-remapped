#include <kernel.h>
#include <sifrpc.h>
#include <loadfile.h>
#include <elf.h>

extern u8 payload_elf[];
extern int size_payload_elf;

inline void _start()
{
        t_ExecData exec;
        Elf32_Ehdr *eh;

        eh = (Elf32_Ehdr *)payload_elf;
        if (eh->e_entry != LOADADDR)
                asm volatile("break\n");

        SifInitRpc(0);

        if (SifLoadElfBuffer(payload_elf, size_payload_elf, &exec) < 0)
                asm volatile("break\n");

        if (exec.epc != LOADADDR)
                asm volatile("break\n");

        FlushCache(0);
        FlushCache(2);

        ExecPS2((void *)exec.epc, (void *)exec.gp, 0, NULL);
}

