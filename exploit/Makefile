#OpenTuna exploit Makefile
#alexparrado (2020)

#Choose paylad you want
PAYLOAD ?= launcher-keys


#OpenTuna load address
LOADADDR  ?= 0x20c020c0



EE_TARGET=payload
EE_BIN = $(EE_TARGET).elf
EE_BIN_RAW = $(EE_TARGET).bin
EE_BIN_STRIPPED = $(EE_TARGET)-stripped.elf
EE_AS_FILES = payload_elf.s
EE_AS_OBJS = $(EE_AS_FILES:.s=.o)
EE_OBJS = main.o $(EE_AS_OBJS)
EE_LDFLAGS +=  -nostartfiles  -Wl,-Ttext -Wl,$(LOADADDR)   -Wl,--gc-sections 
EE_CFLAGS=-Os 

all:
	$(MAKE) $(EE_BIN_RAW) 

payload_elf.s: ../tools/bin2s/bin2s
	$(MAKE) -C ../$(PAYLOAD)/
	../tools/bin2s/bin2s ../$(PAYLOAD)/payload-packed.elf payload_elf.s payload_elf

../tools/bin2s/bin2s:
	$(MAKE) -C ../tools/bin2s

clean:
	$(MAKE) -C ../$(PAYLOAD)/ clean
	rm -f *.elf *.o *.s *.bin

$(EE_BIN_STRIPPED): $(EE_BIN)
	$(EE_STRIP) -s -R .comment -R .gnu.version --strip-unneeded -o $@ $<

#Rule for raw binary to embed into icon.icn 	
$(EE_BIN_RAW): $(EE_BIN_STRIPPED)
	$(EE_OBJCOPY) -O binary -v $< $@ 

include Makefile.pref
include Makefile.eeglobal
