#OpenTuna exploit Makefile
#alexparrado (2020)

#Choose payload you want
PAYLOAD ?= launcher-keys


#OpenTuna load address
LOADADDR  ?= 0x20c020c0


EE_TARGET=payload
EE_BIN = $(EE_TARGET).elf
EE_BIN_RAW = $(EE_TARGET).bin
EE_BIN_STRIPPED = $(EE_TARGET)-stripped.elf
EE_SRCS = main.c
EE_OBJS += payload_elf.o
EE_LDFLAGS += -nostartfiles -Wl,-Ttext=$(LOADADDR),--gc-sections
EE_LIBS = -lc -lpatches
EE_CFLAGS += -Os

all: $(EE_BIN_RAW)

payload_elf.c: ../$(PAYLOAD)/payload-packed.elf ../tools/bin2c/bin2c
	../tools/bin2c/bin2c $< $@ payload_elf

../$(PAYLOAD)/payload-packed.elf:
	$(MAKE) -C ../$(PAYLOAD)

../tools/bin2c/bin2c:
	$(MAKE) -C ../tools/bin2c

clean:
	$(MAKE) -C ../$(PAYLOAD)/ clean
	rm -f *.elf *.o *.s *.c *.bin

$(EE_BIN_STRIPPED): $(EE_BIN)
	$(EE_STRIP) -s -R .comment -R .gnu.version --strip-unneeded -o $@ $<

#Rule for raw binary to embed into icon.icn
$(EE_BIN_RAW): $(EE_BIN_STRIPPED)
	$(EE_OBJCOPY) -O binary -v $< $@

include $(PS2SDK)/Defs.make
include $(PS2SDK)/Rules.make
