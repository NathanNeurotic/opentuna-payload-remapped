#OpenTuna exploit Makefile
#alexparrado (2020)

#Choose payload you want
PAYLOAD ?= launcher-keys

#OpenTuna load address
LOADADDR ?= 0x20c020c0

EE_BIN = payload.elf
EE_OBJS = main.o payload_elf.o

EE_LDFLAGS += -nostartfiles -Wl,-Ttext -Wl,$(LOADADDR) -Wl,--gc-sections
EE_CFLAGS += -Os -DLOADADDR=$(LOADADDR)
EE_LIBS += -lpadload -lloadfile -lsifrpc

all: $(EE_BIN) payload.bin

payload_elf.s:
	$(MAKE) -C ../$(PAYLOAD)/
	bin2s ../$(PAYLOAD)/payload-packed.elf payload_elf.s payload_elf

payload-stripped.elf: $(EE_BIN)
	$(EE_STRIP) -s -R .comment -R .gnu.version --strip-unneeded -o $@ $<

#Rule for raw binary to embed into icon.icn
payload.bin: payload-stripped.elf
	$(EE_OBJCOPY) -O binary -v $< $@

# Override the default clean rule from the template.
clean:
	rm -f *.elf *.o *.s *.bin
	$(MAKE) -C ../$(PAYLOAD)/ clean

include ../mk/Makefile.template
